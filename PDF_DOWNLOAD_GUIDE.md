# Treatment Plan PDF Download Guide

## Overview
The LisaAI system now supports generating comprehensive treatment plans as downloadable PDF documents. This feature provides healthcare providers with professionally formatted, structured treatment plans that can be easily shared with patients, stored in medical records, or printed for physical files.

## Available Endpoints

### 1. Original Endpoint with PDF Option
**Endpoint:** `POST /generate-treatment-plan`

**Query Parameter:**
- `download_pdf` (boolean, optional): Set to `true` to download as PDF instead of JSON

**Example Request:**
```bash
curl -X POST "http://localhost:8000/generate-treatment-plan?download_pdf=true" \
  -H "Content-Type: application/json" \
  -d '{"patient_id": 95}'
```

### 2. Dedicated PDF Endpoint
**Endpoint:** `POST /generate-treatment-plan-pdf`

**Example Request:**
```bash
curl -X POST "http://localhost:8000/generate-treatment-plan-pdf" \
  -H "Content-Type: application/json" \
  -d '{"patient_id": 95}'
```

## PDF Features

### Professional Formatting
- **Title Page**: Professional header with patient information
- **Patient Summary Table**: Key demographic and contact information
- **Structured Sections**: 15 comprehensive treatment plan sections
- **Professional Typography**: Medical-grade formatting with proper fonts and spacing
- **Color Coding**: Different colors for headings, subheadings, and content

### PDF Content Structure
1. **Document Header**
   - Patient name and ID
   - Generation date and time
   - Generated by LISA AI Medical Assistant

2. **Patient Information Table**
   - Demographics (Age, Gender, DOB)
   - Contact information (Phone, Email)
   - Address
   - Insurance information

3. **Treatment Plan Sections**
   - Clinical Assessment & Diagnosis
   - Evidence-Based Treatment Recommendations
   - Medication Management
   - Treatment Protocols & Procedures
   - Monitoring & Surveillance Plan
   - Follow-up & Care Coordination
   - Patient Education & Lifestyle Modifications
   - Complications & Emergency Management
   - Quality of Life & Palliative Considerations
   - Cost Considerations & Access
   - Family History Implications
   - Treatment Adherence Strategies
   - Outcome Expectations & Prognosis
   - Research & Clinical Trials
   - Documentation & Communication

4. **Professional Disclaimer**
   - Legal disclaimers about AI-generated content
   - Medical responsibility statements
   - Usage guidelines

### File Naming Convention
PDFs are automatically named using the following format:
```
TreatmentPlan_{PatientName}_{YYYYMMDD_HHMMSS}.pdf
```

Example: `TreatmentPlan_Armando_W_Conner_20250707_235033.pdf`

## Technical Implementation

### Dependencies Added
- `reportlab>=4.0.0`: PDF generation library

### Key Features
- **Temporary File Management**: Automatic cleanup of temporary files
- **Error Handling**: Graceful fallback to JSON if PDF generation fails
- **Memory Management**: Efficient PDF generation with proper resource cleanup
- **Professional Styling**: Medical-grade document formatting

### PDF Generation Process
1. **Data Retrieval**: Fetch comprehensive patient data from database
2. **LLM Processing**: Generate treatment plan using enhanced prompt
3. **PDF Creation**: Convert treatment plan to professionally formatted PDF
4. **File Response**: Return PDF as downloadable file
5. **Cleanup**: Remove temporary files after download

## Usage Examples

### Frontend Integration (JavaScript)
```javascript
// Download PDF directly
async function downloadTreatmentPlanPDF(patientId) {
    try {
        const response = await fetch('/generate-treatment-plan-pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ patient_id: patientId })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TreatmentPlan_${patientId}_${new Date().toISOString().slice(0,10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            console.error('Failed to generate PDF');
        }
    } catch (error) {
        console.error('Error downloading PDF:', error);
    }
}

// Using query parameter approach
async function downloadTreatmentPlanWithOption(patientId, asPDF = false) {
    try {
        const response = await fetch(`/generate-treatment-plan?download_pdf=${asPDF}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ patient_id: patientId })
        });
        
        if (response.ok) {
            if (asPDF) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `TreatmentPlan_${patientId}_${new Date().toISOString().slice(0,10)}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                const data = await response.json();
                console.log('Treatment plan data:', data);
            }
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
```

### Python Client Example
```python
import requests

def download_treatment_plan_pdf(patient_id, base_url="http://localhost:8000"):
    """Download treatment plan as PDF"""
    try:
        response = requests.post(
            f"{base_url}/generate-treatment-plan-pdf",
            json={"patient_id": patient_id},
            stream=True
        )
        
        if response.status_code == 200:
            # Get filename from response headers
            filename = response.headers.get('content-disposition', '').split('filename=')[-1].strip('"')
            if not filename:
                filename = f"TreatmentPlan_{patient_id}.pdf"
            
            # Save PDF to file
            with open(filename, 'wb') as f:
                for chunk in response.iter_content(chunk_size=8192):
                    f.write(chunk)
            
            print(f"PDF saved as: {filename}")
            return filename
        else:
            print(f"Error: {response.status_code} - {response.text}")
            return None
            
    except Exception as e:
        print(f"Error downloading PDF: {e}")
        return None

# Usage
pdf_file = download_treatment_plan_pdf(95)
```

## Error Handling

### Common Error Scenarios
1. **Patient Not Found**: Returns 404 error
2. **Database Connection Issues**: Returns 500 error with database details
3. **LLM Generation Failure**: Returns 500 error with LLM details
4. **PDF Generation Failure**: Falls back to JSON response with error details

### Error Response Format
```json
{
    "detail": "Error description",
    "pdf_error": "PDF generation failed: specific error message"
}
```

## Best Practices

### For Healthcare Providers
1. **Review Before Use**: Always review AI-generated treatment plans before implementation
2. **Patient Customization**: Modify plans based on individual patient needs
3. **Documentation**: Keep PDFs in patient records for future reference
4. **Legal Compliance**: Ensure compliance with local medical regulations

### For Developers
1. **Error Handling**: Implement proper error handling for PDF generation failures
2. **File Management**: Ensure temporary files are properly cleaned up
3. **User Experience**: Provide clear feedback during PDF generation process
4. **Security**: Validate patient access permissions before generating PDFs

## Security Considerations

### Access Control
- Ensure only authorized users can generate treatment plan PDFs
- Validate patient access permissions
- Log all PDF generation activities

### Data Privacy
- PDFs contain sensitive patient information
- Implement proper data handling and storage policies
- Ensure compliance with HIPAA and other privacy regulations

### File Security
- Temporary files are automatically cleaned up
- PDFs are generated with proper access controls
- Consider encryption for sensitive documents

## Troubleshooting

### Common Issues
1. **PDF Not Downloading**: Check browser settings and file permissions
2. **Large File Sizes**: Optimize content for reasonable file sizes
3. **Formatting Issues**: Verify patient data structure and content
4. **Performance Issues**: Monitor system resources during PDF generation

### Debug Information
- Check application logs for detailed error messages
- Verify database connectivity and patient data availability
- Ensure all required dependencies are installed

## Future Enhancements

### Planned Features
1. **Custom Templates**: Allow customization of PDF templates
2. **Digital Signatures**: Add support for digital signatures
3. **Watermarking**: Add watermarks for document security
4. **Multi-language Support**: Support for multiple languages
5. **Interactive Elements**: Add clickable elements and bookmarks

### Performance Optimizations
1. **Caching**: Cache frequently accessed patient data
2. **Async Processing**: Implement background PDF generation
3. **Compression**: Optimize PDF file sizes
4. **Batch Processing**: Support for generating multiple PDFs

## Support

For technical support or questions about the PDF download functionality:
1. Check the application logs for error details
2. Verify all dependencies are properly installed
3. Test with different patient IDs to isolate issues
4. Contact the development team for complex issues

---

**Note**: This PDF download feature is designed to enhance the workflow of healthcare providers by providing professionally formatted treatment plans. Always ensure that generated plans are reviewed by qualified medical professionals before implementation. 